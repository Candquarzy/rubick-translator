<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>翻译助手</title>
  <style>
    /* Default to system preference before JS loads */
    :root {
      --bg:#f6f7fb; --panel:#ffffff; --surface:#f8fafc; --border:#e5e7eb;
      --muted:#667085; --accent:#3366ff; --text:#1f2937; --green:#16a34a; --red:#ef4444;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg:#0f111a; --panel:#1b1e28; --surface:#0e1017; --border:#293243;
        --muted:#a5adcb; --accent:#7aa2f7; --text:#e5e9f0; --green:#9ece6a; --red:#f7768e;
      }
    }
    :root[data-theme="light"] {
      --bg:#f6f7fb; --panel:#ffffff; --surface:#f8fafc; --border:#e5e7eb;
      --muted:#667085; --accent:#3366ff; --text:#1f2937; --green:#16a34a; --red:#ef4444;
    }
    :root[data-theme="dark"] {
      --bg:#0f111a; --panel:#1b1e28; --surface:#0e1017; --border:#293243;
      --muted:#a5adcb; --accent:#7aa2f7; --text:#e5e9f0; --green:#9ece6a; --red:#f7768e;
    }
    html, body { margin:0; padding:0; background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "PingFang SC", "Microsoft YaHei", sans-serif; }
    .container { padding:12px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .panel { background:var(--panel); border-radius:8px; padding:10px; }
    label { color:var(--muted); font-size:12px; }
    select, input[type="text"] { background:var(--surface); color:var(--text); border:1px solid var(--border); border-radius:6px; padding:6px 8px; outline:none; }
    select:focus, input[type="text"]:focus, textarea:focus { border-color: var(--accent); }
    button { background:var(--accent); color:#0b0e14; border:none; padding:8px 10px; border-radius:6px; cursor:pointer; }
    button.secondary { background:color-mix(in srgb, var(--accent) 15%, var(--surface)); color:var(--text); }
    button.danger { background:var(--red); color:#0b0e14; }
    textarea { width:100%; min-height:110px; resize:vertical; background:var(--surface); color:var(--text); border:1px solid var(--border); border-radius:8px; padding:10px; box-sizing:border-box; }
    .cols { display:grid; grid-template-columns: 1fr; gap:10px; }
    .footer { display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap; }
    .history { max-height:140px; overflow:auto; display:flex; flex-direction:column; gap:8px; }
    .history-item { background:var(--surface); border:1px solid var(--border); border-radius:6px; padding:8px; cursor:pointer; }
    .history-item small { color:var(--muted); }
    .inline { display:inline-flex; gap:6px; align-items:center; }
    .spacer { flex:1 1 auto; }
    .hint { color:var(--muted); font-size:12px; }
    @media (min-width: 860px) { .cols { grid-template-columns: 1fr 1fr; } }
  </style>
  <script>
    const RT = window.rubickTranslator;
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');
    let systemListenerAttached = false;
    let onSystemChange = null;

    function resolveTheme(mode) {
      if (mode === 'dark' || mode === 'light') return mode;
      return (prefersDark && prefersDark.matches) ? 'dark' : 'light';
    }

    function applyTheme(mode) {
      const finalMode = resolveTheme(mode);
      document.documentElement.setAttribute('data-theme', finalMode);
      try { document.documentElement.style.colorScheme = finalMode; } catch {}
      if (mode === 'system') {
        attachSystemListener();
      } else {
        detachSystemListener();
      }
    }

    function attachSystemListener() {
      if (!prefersDark || systemListenerAttached) return;
      onSystemChange = () => applyTheme('system');
      prefersDark.addEventListener('change', onSystemChange);
      systemListenerAttached = true;
    }

    function detachSystemListener() {
      if (!prefersDark || !systemListenerAttached) return;
      prefersDark.removeEventListener('change', onSystemChange);
      systemListenerAttached = false;
    }
    const LANGS = [
      { code: 'auto', name: '自动' },
      { code: 'zh', name: '中文' },
      { code: 'en', name: 'English' },
      { code: 'ja', name: '日本語' },
      { code: 'ko', name: '한국어' },
      { code: 'fr', name: 'Français' },
      { code: 'de', name: 'Deutsch' },
      { code: 'es', name: 'Español' },
      { code: 'ru', name: 'Русский' },
      { code: 'ar', name: 'العربية' },
      { code: 'pt', name: 'Português' },
      { code: 'it', name: 'Italiano' },
      { code: 'hi', name: 'हिन्दी' }
    ];

    function fillSelect(select, options, value) {
      select.innerHTML = '';
      for (const opt of options) {
        const o = document.createElement('option');
        o.value = opt.code; o.textContent = opt.name; select.appendChild(o);
      }
      if (value) select.value = value;
    }

    function isChinese(text) { return /[\u3400-\u9FBF]/.test(text); }

    async function renderHistory() {
      const list = document.getElementById('historyList');
      list.innerHTML = '';
      const items = await RT.getHistory();
      if (!items || items.length === 0) {
        const div = document.createElement('div');
        div.className = 'hint';
        div.textContent = '暂无历史记录';
        list.appendChild(div);
        return;
      }
      for (const item of items) {
        const div = document.createElement('div');
        div.className = 'history-item';
        div.innerHTML = `<div>${item.text ? item.text.slice(0, 120) : ''}</div><small>${item.source} → ${item.target} · ${item.provider}</small>`;
        div.addEventListener('click', () => {
          const inp = document.getElementById('input');
          const out = document.getElementById('output');
          document.getElementById('provider').value = item.provider;
          document.getElementById('sourceLang').value = item.source;
          document.getElementById('targetLang').value = item.target;
          inp.value = item.text;
          out.value = item.translated || '';
          RT.setSubInputValue(item.text);
        });
        list.appendChild(div);
      }
    }

    async function doTranslate(trigger = 'manual') {
      const inp = document.getElementById('input');
      const out = document.getElementById('output');
      const provider = document.getElementById('provider').value;
      let source = document.getElementById('sourceLang').value;
      let target = document.getElementById('targetLang').value;
      const text = inp.value.trim();
      if (!text) { out.value = ''; return; }
      if (source === target && source !== 'auto') { out.value = text; return; }
      if (source === 'auto') target = target || (isChinese(text) ? 'en' : 'zh');
      try {
        const res = await RT.translate({ text, provider, source, target });
        out.value = res.translated || '';
        if (res.detectedSource && document.getElementById('sourceLang').value === 'auto') {
          document.getElementById('sourceLang').value = res.detectedSource;
        }
        await renderHistory();
      } catch (e) {
        out.value = '';
      }
    }

    function bindEvents() {
      document.getElementById('doTranslate').addEventListener('click', () => doTranslate('manual'));
      document.getElementById('copyResult').addEventListener('click', async () => {
        const out = document.getElementById('output').value;
        if (!out) return;
        try { await navigator.clipboard.writeText(out); RT.toast('已复制'); } catch { RT.toast('复制失败'); }
      });
      document.getElementById('swapLang').addEventListener('click', async () => {
        const s = document.getElementById('sourceLang');
        const t = document.getElementById('targetLang');
        const temp = s.value; s.value = t.value; t.value = temp;
        await RT.updateSettings({ lastSourceLang: s.value, lastTargetLang: t.value });
        doTranslate('swap');
      });
      document.getElementById('provider').addEventListener('change', async (e) => {
        await RT.updateSettings({ lastProvider: e.target.value });
        doTranslate('provider-change');
      });
      document.getElementById('sourceLang').addEventListener('change', async (e) => {
        await RT.updateSettings({ lastSourceLang: e.target.value });
        doTranslate('source-change');
      });
      document.getElementById('targetLang').addEventListener('change', async (e) => {
        await RT.updateSettings({ lastTargetLang: e.target.value });
        doTranslate('target-change');
      });
      document.getElementById('ltBaseUrl').addEventListener('change', (e) => {
        RT.updateSettings({ libretranslateBaseUrl: e.target.value || '' });
      });
      document.getElementById('mmEmail').addEventListener('change', (e) => {
        RT.updateSettings({ mymemoryEmail: e.target.value || '' });
      });
      document.getElementById('clearHistory').addEventListener('click', async () => {
        await RT.clearHistory();
        renderHistory();
      });
      document.getElementById('themeMode').addEventListener('change', async (e) => {
        const val = e.target.value;
        await RT.updateSettings({ themeMode: val });
        applyTheme(val);
      });
      const inputEl = document.getElementById('input');
      let debounceTimer;
      inputEl.addEventListener('input', (e) => {
        RT.setSubInputValue(e.target.value);
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => doTranslate('typing'), 350);
      });
    }

    async function bootstrap() {
      await RT.ready();
      const state = await RT.init();
      // Theme
      const themeMode = state?.settings?.themeMode || 'system';
      document.getElementById('themeMode').value = themeMode;
      applyTheme(themeMode);
      fillSelect(document.getElementById('sourceLang'), LANGS, state?.settings?.lastSourceLang || 'auto');
      fillSelect(document.getElementById('targetLang'), LANGS.filter(l => l.code !== 'auto'), state?.settings?.lastTargetLang || 'zh');
      document.getElementById('provider').value = state?.settings?.lastProvider || 'google';
      document.getElementById('ltBaseUrl').value = state?.settings?.libretranslateBaseUrl || 'https://libretranslate.com';
      document.getElementById('mmEmail').value = state?.settings?.mymemoryEmail || '';

      RT.bindSubInput(async ({ text }) => {
        const inp = document.getElementById('input');
        inp.value = text || '';
        if (text && text.trim()) doTranslate('sub-input');
      }, '输入待翻译文本…');

      bindEvents();
      renderHistory();
    }

    window.addEventListener('DOMContentLoaded', bootstrap);
  </script>
</head>
<body>
  <div class="container">
    <div class="row" style="margin-bottom:8px;">
      <div class="inline">
        <strong>翻译助手</strong>
        <span class="hint">· 轻量级 · Google / LibreTranslate / MyMemory</span>
      </div>
      <span class="spacer"></span>
      <label>引擎</label>
      <select id="provider">
        <option value="google">Google(免费)</option>
        <option value="libretranslate">LibreTranslate</option>
        <option value="mymemory">MyMemory</option>
      </select>
      <label>主题</label>
      <select id="themeMode">
        <option value="system">跟随系统</option>
        <option value="light">浅色</option>
        <option value="dark">深色</option>
      </select>
    </div>

    <div class="panel" style="margin-bottom:10px;">
      <div class="row" style="margin-bottom:8px;">
        <label>源语言</label>
        <select id="sourceLang"></select>
        <button id="swapLang" class="secondary">⇄ 交换</button>
        <label>目标语言</label>
        <select id="targetLang"></select>
        <span class="spacer"></span>
        <button id="doTranslate">翻译</button>
      </div>
      <div class="cols">
        <textarea id="input" placeholder="输入或通过子输入框输入…"></textarea>
        <textarea id="output" placeholder="翻译结果" readonly></textarea>
      </div>
      <div class="footer" style="margin-top:8px;">
        <button id="copyResult" class="secondary">复制结果</button>
      </div>
    </div>

    <div class="panel" style="margin-bottom:10px;">
      <div class="row" style="margin-bottom:6px;">
        <strong>设置</strong>
      </div>
      <div class="row" style="gap:12px;">
        <div class="inline" style="gap:6px;">
          <label for="ltBaseUrl">LibreTranslate 地址</label>
          <input id="ltBaseUrl" type="text" style="width:360px;" placeholder="https://libretranslate.com" />
        </div>
        <div class="inline" style="gap:6px;">
          <label for="mmEmail">MyMemory 邮箱(可选)</label>
          <input id="mmEmail" type="text" style="width:240px;" placeholder="用于提升 MyMemory 配额" />
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="row" style="margin-bottom:6px;">
        <strong>历史记录</strong>
        <span class="spacer"></span>
        <button id="clearHistory" class="danger">清空</button>
      </div>
      <div id="historyList" class="history"></div>
    </div>
  </div>
</body>
</html>


